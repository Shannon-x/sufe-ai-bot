package handlers

import (
	"context"
	"encoding/json"
	"fmt"
	"math/rand"
	"strings"
	"time"
	
	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// addMentionGreeting adds a friendly greeting when triggered by mention word
func (h *MessageHandler) addMentionGreeting(message, mentionWord string, update *tgbotapi.Update) string {
	// è·å–æœºå™¨äººæ€§æ ¼è®¾ç½®
	personality := h.config.Context.BotPersonality
	if personality == "" {
		personality = "cute" // é»˜è®¤å¯çˆ±æ€§æ ¼
	}
	// æ ¹æ®æ—¶é—´æ®µå’Œæ€§æ ¼é€‰æ‹©ä¸åŒé£æ ¼çš„é—®å€™
	hour := time.Now().Hour()
	var greetings []string
	
	if hour >= 5 && hour < 9 {
		// æ—©æ™¨é—®å€™
		switch personality {
		case "professional":
			greetings = []string{
				"æ—©ä¸Šå¥½ï¼Œæ–°çš„ä¸€å¤©å¼€å§‹äº†ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ",
				"æ—©å®‰ï¼Œæˆ‘å·²å‡†å¤‡å¥½ä¸ºæ‚¨æœåŠ¡ã€‚",
				"æ—©ä¸Šå¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆéœ€è¦ååŠ©çš„ï¼Ÿ",
			}
		case "humorous":
			greetings = []string{
				"æ—©èµ·çš„é¸Ÿå„¿æœ‰è™«åƒï¼Œæ—©èµ·çš„ä½ æœ‰AIé™ªï¼ğŸ˜„",
				"å“‡ï¼è¿™ä¹ˆæ—©å°±èµ·æ¥äº†ï¼Ÿæ˜¯å¤ªé˜³ä»è¥¿è¾¹å‡ºæ¥äº†å—ï¼Ÿ",
				"æ—©å®‰ï¼å’–å•¡å–äº†å—ï¼Ÿæˆ‘å·²ç»å……æ»¡ç”µäº†ï¼âš¡",
			}
		case "warm":
			greetings = []string{
				"æ—©ä¸Šå¥½ï¼å¸Œæœ›ä½ ä»Šå¤©æœ‰ä¸ªç¾å¥½çš„å¼€å§‹ï½",
				"æ—©å®‰ï¼Œæ–°çš„ä¸€å¤©å……æ»¡å¸Œæœ›ï¼æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ",
				"æ—©æ™¨å¥½ï¼é˜³å…‰æ­£å¥½ï¼Œå¿ƒæƒ…ä¹Ÿè¦ç¾ç¾çš„å“¦ï½",
			}
		default: // cute
			greetings = []string{
				"æ—©ä¸Šå¥½å‘€ï¼æ–°çš„ä¸€å¤©ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼Ÿâ˜€ï¸",
				"æ—©å®‰ï¼æˆ‘åœ¨è¿™é‡Œï¼Œè¯·é—®éœ€è¦ä»€ä¹ˆå¸®åŠ©å‘¢ï¼ŸğŸŒ…",
				"ç¾å¥½çš„æ—©æ™¨ï¼æœ‰ä»€ä¹ˆé—®é¢˜å°½ç®¡é—®æˆ‘å“¦ï½",
				"æ—©ä¸Šå¥½ï¼ä»Šå¤©æƒ³èŠç‚¹ä»€ä¹ˆå‘¢ï¼ŸğŸ˜Š",
				"æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼æˆ‘èƒ½ä¸ºä½ åšäº›ä»€ä¹ˆï¼ŸğŸŒ¸",
			}
		}
	} else if hour >= 9 && hour < 12 {
		// ä¸Šåˆé—®å€™
		switch personality {
		case "professional":
			greetings = []string{
				"ä¸Šåˆå¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥ä¸ºæ‚¨æœåŠ¡çš„å—ï¼Ÿ",
				"æ‚¨å¥½ï¼Œä¸Šåˆæ—¶é—´å……è£•ï¼Œè¯·é—®éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ",
				"ä¸Šåˆå¥½ï¼Œæˆ‘å·²å‡†å¤‡å¥½ååŠ©æ‚¨å¤„ç†é—®é¢˜ã€‚",
			}
		case "humorous":
			greetings = []string{
				"ä¸Šåˆå¥½ï¼å’–å•¡å–äº†å—ï¼Ÿæˆ‘å·²ç»æ»¡è¡€å¤æ´»å•¦ï¼â˜•",
				"å“Ÿï¼å·¥ä½œæ—¶é—´æ‘¸é±¼æ‰¾æˆ‘èŠå¤©ï¼Ÿæˆ‘æ‡‚çš„ï½ğŸ˜",
				"ä¸Šåˆå¥½ï¼è®©æˆ‘ä»¬ä¸€èµ·æ„‰å¿«åœ°åº¦è¿‡è¿™æ®µæ—¶å…‰å§ï¼",
			}
		case "warm":
			greetings = []string{
				"ä¸Šåˆå¥½ï¼å¸Œæœ›ä½ ä»Šå¤©çŠ¶æ€æ»¡æ»¡ï½æœ‰ä»€ä¹ˆæƒ³èŠçš„ï¼Ÿ",
				"ä½ å¥½å‘€ï¼ä¸Šåˆçš„é˜³å…‰å¾ˆå¥½ï¼Œå¿ƒæƒ…ä¹Ÿè¦ç¾ç¾çš„å“¦ï½",
				"ä¸Šåˆå¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼Ÿæˆ‘ä¸€ç›´åœ¨è¿™é‡Œï½",
			}
		default: // cute
			greetings = []string{
				"ä½ å¥½å‘€ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼ŸğŸ˜Š",
				"å—¨ï½æˆ‘åœ¨è¿™é‡Œï¼éœ€è¦ä»€ä¹ˆå¸®åŠ©å‘¢ï¼Ÿ",
				"ä½ å¥½ï¼æœ‰ä»€ä¹ˆé—®é¢˜æƒ³é—®æˆ‘å—ï¼ŸğŸŒŸ",
				"å®å’šï½æœ‰äººæ‰¾æˆ‘å—ï¼Ÿè¯·è¯´ï½",
				"åœ¨çš„åœ¨çš„ï¼æœ‰ä»€ä¹ˆå¯ä»¥æ•ˆåŠ³çš„ï¼Ÿâœ¨",
			}
		}
	} else if hour >= 12 && hour < 14 {
		// åˆé—´é—®å€™
		switch personality {
		case "professional":
			greetings = []string{
				"åˆå®‰ï¼Œåˆä¼‘æ—¶é—´æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ",
				"ä¸­åˆå¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆéœ€è¦ååŠ©çš„ï¼Ÿ",
				"åˆé—´å¥½ï¼Œæˆ‘åœ¨è¿™é‡Œä¸ºæ‚¨æœåŠ¡ã€‚",
			}
		case "humorous":
			greetings = []string{
				"åˆé¥­åƒäº†å—ï¼Ÿæ²¡åƒçš„è¯å…ˆèŠå¤©å¡«å¡«è‚šå­ï¼ŸğŸ˜„",
				"åˆå®‰ï¼æ˜¯ä¸æ˜¯åƒé¥±äº†æƒ³æ‰¾äººèŠå¤©æ¶ˆé£Ÿï¼Ÿ",
				"ä¸­åˆå¥½ï¼è®©æˆ‘çŒœçŒœï¼Œä½ æ˜¯ä¸æ˜¯åœ¨ç­‰å¤–å–ï¼ŸğŸ±",
			}
		case "warm":
			greetings = []string{
				"åˆå®‰ï¼è®°å¾—å¥½å¥½åƒé¥­å“¦ï½æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ",
				"ä¸­åˆå¥½ï¼åˆä¼‘æ—¶å…‰ï¼Œæ”¾æ¾ä¸€ä¸‹å§ï½",
				"ä½ å¥½ï¼å¸Œæœ›ä½ æœ‰ä¸ªæ„‰å¿«çš„åˆé¤æ—¶é—´ï½",
			}
		default: // cute
			greetings = []string{
				"åˆå®‰ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼ŸğŸŒ",
				"ä½ å¥½ï½åˆä¼‘æ—¶é—´ï¼Œè½»æ¾èŠèŠï¼Ÿ",
				"å—¨ï¼æœ‰ä»€ä¹ˆæƒ³é—®çš„å°½ç®¡è¯´ï½ğŸ˜Š",
				"æˆ‘åœ¨å‘¢ï¼éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ",
				"åˆé—´å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥ä¸ºä½ è§£ç­”çš„ï¼Ÿ",
			}
		}
	} else if hour >= 14 && hour < 18 {
		// ä¸‹åˆé—®å€™
		switch personality {
		case "professional":
			greetings = []string{
				"ä¸‹åˆå¥½ï¼Œæœ‰ä»€ä¹ˆå·¥ä½œä¸Šçš„é—®é¢˜éœ€è¦å¸®åŠ©å—ï¼Ÿ",
				"æ‚¨å¥½ï¼Œä¸‹åˆæ—¶å…‰ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥ååŠ©çš„ï¼Ÿ",
				"ä¸‹åˆå¥½ï¼Œæˆ‘éšæ—¶å‡†å¤‡ä¸ºæ‚¨è§£ç­”é—®é¢˜ã€‚",
			}
		case "humorous":
			greetings = []string{
				"ä¸‹åˆå¥½ï¼æ˜¯ä¸æ˜¯çŠ¯å›°äº†æ¥æ‰¾æˆ‘æç¥ï¼ŸğŸ˜†",
				"å—¨ï¼ä¸‹åˆèŒ¶æ—¶é—´åˆ°ï¼ŒèŠå¤©é…èŒ¶æ›´é¦™å“¦ï½â˜•",
				"ä¸‹åˆå¥½ï¼è®©æˆ‘ä»¬ä¸€èµ·æˆ˜èƒœå›°æ„å§ï¼ğŸ’ª",
			}
		case "warm":
			greetings = []string{
				"ä¸‹åˆå¥½ï¼å·¥ä½œç´¯äº†å§ï¼Ÿä¼‘æ¯ä¸€ä¸‹èŠèŠå¤©ï½",
				"ä½ å¥½ï¼ä¸‹åˆçš„æ—¶å…‰æ€»æ˜¯è¿‡å¾—å¾ˆå¿«å‘¢ï½",
				"ä¸‹åˆå¥½ï¼æœ‰ä»€ä¹ˆçƒ¦æ¼å¯ä»¥è·Ÿæˆ‘è¯´è¯´å“¦ï½",
			}
		default: // cute
			greetings = []string{
				"ä¸‹åˆå¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿâ˜•",
				"ä½ å¥½å‘€ï¼ä¸‹åˆæ—¶å…‰ï¼Œæœ‰ä»€ä¹ˆæƒ³èŠçš„ï¼Ÿ",
				"å—¨ï½æˆ‘åœ¨è¿™é‡Œï¼Œæœ‰é—®é¢˜å°½ç®¡é—®ï¼",
				"å®ï½æœ‰äººå‘¼å«æˆ‘å—ï¼Ÿè¯·è®²ï½ğŸ˜Š",
				"ä¸‹åˆå¥½ï¼éœ€è¦ä»€ä¹ˆå¸®åŠ©å‘¢ï¼ŸğŸŒ¤ï¸",
			}
		}
	} else if hour >= 18 && hour < 22 {
		// æ™šé—´é—®å€™
		switch personality {
		case "professional":
			greetings = []string{
				"æ™šä¸Šå¥½ï¼Œä»Šå¤©è¾›è‹¦äº†ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ",
				"æ™šå®‰ï¼Œè¯·é—®æœ‰ä»€ä¹ˆéœ€è¦ååŠ©çš„ï¼Ÿ",
				"æ™šä¸Šå¥½ï¼Œæˆ‘åœ¨è¿™é‡Œéšæ—¶ä¸ºæ‚¨æœåŠ¡ã€‚",
			}
		case "humorous":
			greetings = []string{
				"æ™šä¸Šå¥½ï¼æ˜¯æ¥æ‰¾æˆ‘èŠå¤©è§£é—·çš„å—ï¼ŸğŸŒ™",
				"å—¨ï¼å¤œç”Ÿæ´»å¼€å§‹äº†ï¼Œæœ‰ä»€ä¹ˆç²¾å½©çš„äº‹è¦åˆ†äº«å—ï¼Ÿ",
				"æ™šä¸Šå¥½ï¼è®©æˆ‘ä»¬ä¸€èµ·åº¦è¿‡è¿™ä¸ªç¾å¥½çš„å¤œæ™šå§ï¼âœ¨",
			}
		case "warm":
			greetings = []string{
				"æ™šä¸Šå¥½ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ",
				"æ™šå®‰ï½ç´¯äº†ä¸€å¤©äº†å§ï¼Ÿæˆ‘åœ¨è¿™é‡Œé™ªä½ èŠå¤©ï½",
				"ä½ å¥½ï¼æ™šä¸Šæ˜¯æ”¾æ¾çš„å¥½æ—¶å…‰ï¼Œæœ‰ä»€ä¹ˆçƒ¦æ¼éƒ½å¯ä»¥è¯´ç»™æˆ‘å¬ï½",
			}
		default: // cute
			greetings = []string{
				"æ™šä¸Šå¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼ŸğŸŒ™",
				"æ™šå®‰ï½æœ‰ä»€ä¹ˆæƒ³é—®çš„å—ï¼Ÿ",
				"ä½ å¥½ï¼æ™šé—´æ—¶å…‰ï¼Œéœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿâœ¨",
				"å—¨ï½æˆ‘åœ¨è¿™é‡Œï¼Œæœ‰ä»€ä¹ˆå¯ä»¥æ•ˆåŠ³çš„ï¼Ÿ",
				"æ™šä¸Šå¥½å‘€ï¼æœ‰é—®é¢˜å°½ç®¡é—®æˆ‘ï½ğŸ˜Š",
			}
		}
	} else {
		// æ·±å¤œé—®å€™
		switch personality {
		case "professional":
			greetings = []string{
				"æ·±å¤œäº†ï¼Œæ‚¨è¿˜åœ¨å·¥ä½œå—ï¼Ÿæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©çš„ï¼Ÿ",
				"å¤œæ·±äº†ï¼Œè¯·é—®æœ‰ä»€ä¹ˆç´§æ€¥çš„äº‹æƒ…éœ€è¦ååŠ©ï¼Ÿ",
				"æ·±å¤œå¥½ï¼Œæˆ‘ä¾ç„¶åœ¨è¿™é‡Œä¸ºæ‚¨æœåŠ¡ã€‚",
			}
		case "humorous":
			greetings = []string{
				"å“‡ï¼å¤œçŒ«å­å‡ºæ²¡ï¼æ˜¯å¤±çœ äº†è¿˜æ˜¯åœ¨ä¿®ä»™ï¼ŸğŸ¦‰",
				"æ·±å¤œå¥½ï¼æ˜¯ä¸æ˜¯åˆ·æ‰‹æœºåˆ·åˆ°æˆ‘è¿™é‡Œæ¥äº†ï¼ŸğŸ˜„",
				"è¿™ä¹ˆæ™šäº†è¿˜ä¸ç¡ï¼Ÿæ¥æ¥æ¥ï¼Œè®©æˆ‘è®²ä¸ªç¬‘è¯åŠ©çœ ï½",
			}
		case "warm":
			greetings = []string{
				"å¤œæ·±äº†ï¼Œè¿˜æ²¡ä¼‘æ¯å—ï¼Ÿæœ‰ä»€ä¹ˆå¿ƒäº‹å¯ä»¥è·Ÿæˆ‘è¯´è¯´ï½",
				"æ·±å¤œå¥½ï¼ç¡ä¸ç€çš„è¯ï¼Œæˆ‘é™ªä½ èŠèŠå¤©å§ï½",
				"è¿™ä¹ˆæ™šäº†ï¼Œè¦æ³¨æ„ä¼‘æ¯å“¦ï½æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ",
			}
		default: // cute
			greetings = []string{
				"å¤œæ·±äº†ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼ŸğŸŒ™",
				"è¿˜æ²¡ç¡å‘€ï¼Ÿæœ‰ä»€ä¹ˆæƒ³é—®çš„å—ï¼Ÿ",
				"æ·±å¤œå¥½ï¼æˆ‘ä¸€ç›´åœ¨è¿™é‡Œï½",
				"å¤œçŒ«å­ä½ å¥½ï¼éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼ŸğŸ¦‰",
				"è¿™ä¹ˆæ™šäº†ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥ä¸ºä½ è§£ç­”çš„ï¼ŸğŸ’«",
			}
		}
	}
	
	// æ ¹æ®æ€§æ ¼æ·»åŠ é€šç”¨é—®å€™
	var generalGreetings []string
	switch personality {
	case "professional":
		generalGreetings = []string{
			"æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ",
			"æ‚¨å¥½ï¼Œæˆ‘åœ¨è¿™é‡Œä¸ºæ‚¨æœåŠ¡ã€‚",
			"æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼Œè¯·é—®æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„ï¼Ÿ",
			"æ‚¨å¥½ï¼Œæˆ‘å‡†å¤‡å¥½ä¸ºæ‚¨è§£ç­”é—®é¢˜äº†ã€‚",
			"åœ¨çš„ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥ååŠ©æ‚¨çš„ï¼Ÿ",
		}
	case "humorous":
		generalGreetings = []string{
			"å“Ÿï¼æœ‰äººå«æˆ‘ï¼Ÿæ˜¯è¦å¬ä¸ªç¬‘è¯å—ï¼ŸğŸ˜„",
			"å®å’šï¼å¤–å–...å“¦ä¸å¯¹ï¼Œæ˜¯AIåŠ©æ‰‹åˆ°ï¼",
			"å˜¿ï¼è¢«ä½ å‘ç°æˆ‘äº†ï½æœ‰å•¥å¥½ç©çš„äº‹å—ï¼Ÿ",
			"æŠ¥å‘Šï¼AIå°åŠ©æ‰‹å‰æ¥æŠ¥åˆ°ï¼æœ‰ä½•æŒ‡ç¤ºï¼Ÿ",
			"å“ˆå–½ï¼ä»Šå¤©æƒ³èŠç‚¹å•¥æœ‰è¶£çš„ï¼ŸğŸ­",
		}
	case "warm":
		generalGreetings = []string{
			"ä½ å¥½å‘€ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®å¿™çš„å—ï¼Ÿ",
			"å—¨ï¼Œæœ‹å‹ï¼æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼Ÿ",
			"ä½ å¥½ï¼æˆ‘ä¸€ç›´åœ¨è¿™é‡Œé™ªç€ä½ å‘¢ï½",
			"å¾ˆé«˜å…´æ”¶åˆ°ä½ çš„æ¶ˆæ¯ï¼éœ€è¦ä»€ä¹ˆå¸®åŠ©å—ï¼Ÿ",
			"ä½ æ¥å•¦ï¼æœ‰ä»€ä¹ˆå¯ä»¥ä¸ºä½ åšçš„å—ï¼Ÿæ¸©æš–çš„æ‹¥æŠ±ï½",
		}
	default: // cute
		generalGreetings = []string{
			"å®å’šï½æœ‰äººåœ¨æ‰¾æˆ‘å—ï¼ŸğŸ˜Š",
			"å—¨å—¨ï¼æˆ‘æ¥å•¦ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®å¿™çš„ï¼Ÿ",
			"ä½ å¥½å‘€ï¼æœ‰ä»€ä¹ˆæƒ³é—®çš„å°½ç®¡è¯´ï½",
			"åœ¨çš„åœ¨çš„ï¼éœ€è¦ä»€ä¹ˆå¸®åŠ©å‘¢ï¼Ÿâœ¨",
			"å˜¿ï½å¬åˆ°æœ‰äººå«æˆ‘ï¼æ€ä¹ˆå•¦ï¼Ÿ",
			"æˆ‘åœ¨è¿™é‡Œå“¦ï¼æœ‰ä»€ä¹ˆå¯ä»¥æ•ˆåŠ³çš„ï¼Ÿ",
			"å®ï½æ”¶åˆ°å‘¼å«ï¼è¯·é—®æœ‰ä»€ä¹ˆéœ€è¦å¸®åŠ©çš„ï¼Ÿ",
			"ä½ å¥½ï¼æˆ‘å‡†å¤‡å¥½å›ç­”ä½ çš„é—®é¢˜å•¦ï½",
			"å—¨å‘€ï¼æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼ŸğŸ˜Š",
			"æ¥å•¦æ¥å•¦ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„ï¼Ÿ",
		}
	}
	
	// åˆå¹¶é—®å€™è¯­
	allGreetings := append(greetings, generalGreetings...)
	
	// è·å–æœ€è¿‘ä½¿ç”¨çš„é—®å€™è¯­å†å²
	var recentGreetings []int
	recentGreetingsKey := fmt.Sprintf("recent_greetings_%d", update.Message.Chat.ID)
	recentGreetingsStr, err := h.storage.GetUserState(context.Background(), update.Message.From.ID, recentGreetingsKey)
	if err == nil && recentGreetingsStr != "" {
		json.Unmarshal([]byte(recentGreetingsStr), &recentGreetings)
	}
	
	// åˆ›å»ºå€™é€‰ç´¢å¼•åˆ—è¡¨ï¼ˆæ’é™¤æœ€è¿‘ä½¿ç”¨çš„ï¼‰
	candidateIndices := []int{}
	for i := 0; i < len(allGreetings); i++ {
		isRecent := false
		for _, recentIdx := range recentGreetings {
			if i == recentIdx {
				isRecent = true
				break
			}
		}
		if !isRecent {
			candidateIndices = append(candidateIndices, i)
		}
	}
	
	// å¦‚æœæ‰€æœ‰é—®å€™è¯­éƒ½æœ€è¿‘ä½¿ç”¨è¿‡ï¼Œæ¸…ç©ºå†å²
	if len(candidateIndices) == 0 {
		recentGreetings = []int{}
		for i := 0; i < len(allGreetings); i++ {
			candidateIndices = append(candidateIndices, i)
		}
	}
	
	// éšæœºé€‰æ‹©ä¸€ä¸ªé—®å€™è¯­
	rand.Seed(time.Now().UnixNano())
	selectedIdx := candidateIndices[rand.Intn(len(candidateIndices))]
	greeting := allGreetings[selectedIdx]
	
	// æ›´æ–°æœ€è¿‘ä½¿ç”¨çš„é—®å€™è¯­å†å²ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
	recentGreetings = append(recentGreetings, selectedIdx)
	if len(recentGreetings) > 5 {
		recentGreetings = recentGreetings[len(recentGreetings)-5:]
	}
	
	// ä¿å­˜æ›´æ–°åçš„å†å²
	updatedRecentGreetingsStr, _ := json.Marshal(recentGreetings)
	h.storage.SetUserState(context.Background(), update.Message.From.ID, recentGreetingsKey, string(updatedRecentGreetingsStr))
	
	// If the message only contains the mention word, just return the greeting
	trimmed := strings.TrimSpace(message)
	if strings.EqualFold(trimmed, mentionWord) || trimmed == "" {
		return greeting
	}
	
	// Otherwise, acknowledge the mention and process the message
	return fmt.Sprintf("%s\n\nå…³äºä½ çš„é—®é¢˜ï¼š%s", greeting, message)
}